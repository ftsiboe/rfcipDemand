---
title: "rfcipDemand"
output:
  github_document:
    toc: false
    toc_depth: 3
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment  = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

<!-- badges: start -->
[![Project Status: Active – The project has reached a stable, usable
state and is being actively
developed.](https://www.repostatus.org/badges/latest/active.svg)](https://www.repostatus.org/#active)
[![Lifecycle:
experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![R-CMD-check](https://github.com/ftsiboe/rfcipDemand/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/ftsiboe/rfcipDemand/actions/workflows/R-CMD-check.yaml)
[![codecov](https://codecov.io/gh/ftsiboe/rfcipDemand/graph/badge.svg?token=6MKGP8Z5NB)](https://codecov.io/gh/ftsiboe/rfcipDemand)
![R >= 4.0](https://img.shields.io/badge/R-%3E=4.0-blue)
[![Contributor Covenant](https://img.shields.io/badge/Contributor%20Covenant-2.1-4baaaa.svg)](code_of_conduct.md)
![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)
<!-- badges: end -->

# 📖 Introduction

`rfcipDemand` provides a reproducible pipeline for analyzing **U.S. Federal Crop Insurance Program (FCIP) demand**.

Its functionalities are grounded in the empirical strategies developed in:  

- Tsiboe, F., & Turner, D. (2023). [**The crop insurance demand response to premium subsidies: Evidence from U.S. Agriculture**](https://doi.org/10.1016/j.foodpol.2023.102505) Food Policy, 119(3). 
    
- Tsiboe, F., & Turner, D. (2023). [**Econometric identification of crop insurance participation**](https://doi.org/10.1017/age.2023.13) Agricultural and Resource Economics Review

Specifically, the package helps you:

- 🧩 Build county–crop–practice–plan–unit panels from **USDA RMA SOBTPU** and related sources  
- 🔗 Merge **price and instrument variables**  
- 🌾 Reconcile **acreage** using FSA and NASS data  
- 📊 Estimate **FCIP demand systems** with fixed effects and two-way cluster-robust covariance  
- ✅ Produce diagnostics, including robust first-stage strength  

**Disclaimer:** This package uses USDA data but is not endorsed by or affiliated with USDA or the Federal Government.  
See [LICENSE](LICENSE) for terms.

---

# 📦 Installation

```{r install, eval=FALSE}
# Install from GitHub
if (!requireNamespace("devtools", quietly = TRUE)) install.packages("devtools")
devtools::install_github("ftsiboe/rfcipDemand", force = TRUE, upgrade = "never")
```

---

# 🚀 Quick Start

The two most important functions are:

- `fcip_demand_data_dispatcher()` → assemble the modeling panel  
- `fcip_demand_sys_estimate()` → estimate demand equations

## Example 1: Full sample estimation
Model structure aligned to the approach in [Tsiboe & Turner (2023)](https://doi.org/10.1016/j.foodpol.2023.102505), updated with recent data.  
**NOTE:** Results may differ from the published articles due to RMA data revisions and pipeline improvements in this package.  
If you need *exact* replication of a paper, please use that study's dedicated replication package (link to be added).

**Data**

```{r quick-start-data, eval=FALSE, warning=FALSE}
# library(rfcipDemand)
devtools::document()
# 1) Identify fields for panel building
FCIP_INSURANCE_POOL <- c("state_code","county_code","commodity_code","type_code","practice_code")

# 2) Build data (example years - keep short so examples are fast)
df <- fcip_demand_data_dispatcher(
  study_years = 2001:2024,
  identifiers = c("commodity_year", FCIP_INSURANCE_POOL, "insurance_plan_code", "unit_structure_code")
)

# 3) Prep variables (toy scaling for demo)
data                <- as.data.frame(df)
data$Gamma          <- data$net_reporting_level_amount / 10000
data$Theta1         <- data$coverage_level_percent_aggregate
data$rate           <- data$premium_per_liability*(1-data$subsidy_per_premium)
data$county_acreage <- data$county_acreage / 10000
data$rent           <- data$rent / 1000
data$trend          <- data$commodity_year - min(data$commodity_year, na.rm=TRUE)
data$FCIP           <- 1
data$tauS0        <- data$tau*(1-((data$subsidy_rate_65+data$subsidy_rate_75)/2))

for(i in unique(data$commodity_code)){ data[,paste0("Crop_",i)] <- ifelse(data$commodity_code %in% i,1,0)*data$trend }
for(i in unique(data$commodity_year)){ data[,paste0("year_",i)] <- ifelse(data$commodity_year %in% i,1,0) }
data <- data[names(data)[!names(data) %in% c(paste0("year_",max(data$commodity_year,na.rm=T)),"Crop_41")]]

```

**🧮 Estimate the model**

```{r quick-start-estimate, eval=FALSE, warning=FALSE}
# 4) Specify the system

model <- list(
  name       = "demo_sys",
  FE         = TRUE,
  outcome    = c("Gamma","Theta1"),
  endogenous = "rate",
  excluded   = "tauS0",
  partial    = c("trend",names(data)[grepl("Crop_",names(data))],names(data)[grepl("year_",names(data))]),
  disag      = "FCIP",
  included   = c("county_acreage","price","rent")
)

# 5) Estimate demand system
res <- fcip_demand_sys_estimate(model = model, data = data)

write.csv(res,"data-raw/examples/example1.csv")

```

**📊 Discussion of Results**

The outputs from `fcip_demand_sys_estimate()` are structured objects that typically include:

- **System coefficients**: Estimated elasticities of demand with respect to premium rates, coverage levels, and control variables.  
- **Robust inference**: Standard errors clustered by county and year, consistent with best practices in applied demand modeling.  
- **First-stage diagnostics**: Strength of excluded instruments (e.g., `tau`), ensuring valid identification of the endogenous premium rate.  
- **Equation-level summaries**: For multi-equation systems, results are returned per outcome (e.g., insured acreage (`Gamma`) and coverage level (`Theta1`)).  

```r
# Example 1 Output
    demand                 coef                        Estimate     StdError      Zvalue  Pvalue    model endogenous     FE     name  disag  level
    <char>               <char>                           <num>        <num>       <num>   <num>   <char>     <char> <lgcl>   <char> <char> <char>
 1:  Gamma          (Intercept)       0.00000000000000009620557 0.0049082100  0.00000000 1.00000 demo_sys       rate   TRUE demo_sys   FCIP      1
 2:  Gamma           tilda_rate      -0.47598862988030482545909 2.2599672784 -0.21061749 0.83319 demo_sys       rate   TRUE demo_sys   FCIP      1
 3:  Gamma tilda_county_acreage       0.02375448208427862958891 0.0115885905  2.04981633 0.04038 demo_sys       rate   TRUE demo_sys   FCIP      1
 4:  Gamma          tilda_price       0.00188388106365355574405 0.0082705724  0.22778122 0.81982 demo_sys       rate   TRUE demo_sys   FCIP      1
 5:  Gamma           tilda_rent       0.42348960204379315630518 2.9927121999  0.14150696 0.88747 demo_sys       rate   TRUE demo_sys   FCIP      1
 6:  Theta          (Intercept)       0.00000000000000040452071 0.0023858346  0.00000000 1.00000 demo_sys       rate   TRUE demo_sys   FCIP      1
 7:  Theta           tilda_rate      -0.35874792372045244404077 0.4228440492 -0.84841663 0.39621 demo_sys       rate   TRUE demo_sys   FCIP      1
 8:  Theta tilda_county_acreage      -0.00060714094882705787505 0.0005801842 -1.04646233 0.29535 demo_sys       rate   TRUE demo_sys   FCIP      1
 9:  Theta          tilda_price      -0.00015009695900695911174 0.0012070329 -0.12435200 0.90104 demo_sys       rate   TRUE demo_sys   FCIP      1
10:  Theta           tilda_rent       0.01307193589246588398545 0.5185976994  0.02520631 0.97989 demo_sys       rate   TRUE demo_sys   FCIP      1
11:  Total           tilda_rate      -0.66397662091665499151105 1.6478758704 -0.40292878 0.68700 demo_sys       rate   TRUE demo_sys   FCIP      1
12:  Total tilda_county_acreage       0.02313291881666002663964 0.0118048770  1.95960694 0.05004 demo_sys       rate   TRUE demo_sys   FCIP      1
13:  Total          tilda_price       0.00173350133982781142925 0.0085377154  0.20304042 0.83910 demo_sys       rate   TRUE demo_sys   FCIP      1
14:  Total           tilda_rent       0.44209736686530137772522 3.6720340147  0.12039577 0.90417 demo_sys       rate   TRUE demo_sys   FCIP      1
15:                           N 1917600.00000000000000000000000           NA          NA      NA demo_sys       rate   TRUE demo_sys   FCIP      1
16:                         NFE       1.00000000000000000000000           NA          NA      NA demo_sys       rate   TRUE demo_sys   FCIP      1
17:                 residCov_11       1.34892891790689017916804           NA          NA      NA demo_sys       rate   TRUE demo_sys   FCIP      1
18:                 residCov_22       0.00612981995488134055738           NA          NA      NA demo_sys       rate   TRUE demo_sys   FCIP      1
19:                 residCov_12       0.01361366587160771704501           NA          NA      NA demo_sys       rate   TRUE demo_sys   FCIP      1
20:                       JTest       0.00000000000000000000000           NA          NA      NA demo_sys       rate   TRUE demo_sys   FCIP      1
21:                       FTest     125.04411846437918143237766           NA          NA 0.00000 demo_sys       rate   TRUE demo_sys   FCIP      1
    demand                 coef                        Estimate     StdError      Zvalue  Pvalue    model endogenous     FE     name  disag  level
```

***Interpreting key results***

- A **negative and significant coefficient on `rate`** implies that higher premium rates reduce demand for coverage, consistent with economic theory.  
- Significant coefficients on controls like `county_acreage` and `rent` highlight how local production environments affect insurance demand.  
- **Instrument strength (F-statistics)** should be monitored to validate the causal interpretation of `rate` coefficients.  

---

# 📚 Citation

If you use `rfcipDemand` in your research, please cite:

- Tsiboe, F., & Turner, D. (2023). [**The crop insurance demand response to premium subsidies: Evidence from U.S. Agriculture**](https://doi.org/10.1016/j.foodpol.2023.102505) Food Policy, 119(3). 
    
- Tsiboe, F., & Turner, D. (2023). [**Econometric identification of crop insurance participation**](https://doi.org/10.1017/age.2023.13) Agricultural and Resource Economics Review

---

# 🤝 Contributing

Contributions, issues, and feature requests are welcome. Please see the [Code of Conduct](code_of_conduct.md).

---

# 📬 Contact

Questions or collaboration ideas?  
Email **Francis Tsiboe** at [ftsiboe@hotmail.com](mailto:ftsiboe@hotmail.com).  
Star the repo ⭐ if you find it useful!
