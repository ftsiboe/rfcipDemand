% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fcip_demand_data_dispatcher.R
\name{fcip_demand_data_prep_sob}
\alias{fcip_demand_data_prep_sob}
\title{Prep SOBTPU and compute coverage/financial aggregates for demand estimation}
\usage{
fcip_demand_data_prep_sob(
  study_years = 2001:(as.numeric(format(Sys.Date(), "\%Y")) - 1),
  identifiers = c("commodity_year", FCIP_INSURANCE_POOL, "insurance_plan_code",
    "unit_structure_code")
)
}
\arguments{
\item{study_years}{Integer vector of commodity years to include.
Defaults to \code{2001:(as.numeric(format(Sys.Date(), "\%Y")) - 1)}.}

\item{identifiers}{Character vector of grouping keys that define the aggregation grain.
Must be columns present in SOBTPU (e.g., \code{"commodity_year"}, \code{FCIP_INSURANCE_POOL},
\code{"insurance_plan_code"}, \code{"unit_structure_code"}, and-if desired-additional keys like
\code{"commodity_code"} or \code{"practice_code"}). Enrichment joins for recodes are performed
only when the required keys are included in \code{identifiers} (see details below).}
}
\value{
A \code{data.table} at the chosen identifier grain with coverage aggregates and the
columns listed under \strong{What this stage produces}.
}
\description{
Loads RMA Summary of Business (SOBTPU) data, filters valid observations, normalizes
coverage levels, computes coverage summaries, and collapses financials at a chosen
identifier grain. Optionally enriches with recode tables depending on which keys are
present in \code{identifiers}.
}
\details{
\strong{Normalization of coverage}: values > 1 are treated as percentages and converted to
proportions, snapped to a 0.05 grid, and clamped to 0.50:0.95.

\strong{Aggregation}:
\itemize{
\item Per-identifier coverage summaries: max, mean, mode (dominant), and weighted average
(weights = \code{net_reporting_level_amount}).
\item \code{potential_liability_amount = liability_amount / coverage_level_percent}
\item \code{coverage_level_percent_aggregate = liability_amount / potential_liability_amount}
}

\strong{Optional enrichment} (requires certain keys in \code{identifiers}):
\itemize{
\item Commodity grouping (\code{commodity_year + commodity_code})
\item Practice recodes (\code{commodity_year + commodity_code + practice_code})
\item Insurance plan recodes (\code{commodity_year + insurance_plan_code}, filtered to
\code{triger_level == "Individual"})
}

\strong{Environment requirements} (for optional enrichment):
\itemize{
\item \code{fcip_recodes_commodity_groupings}, \code{fcip_recodes_practice},
\code{fcip_recodes_insurance_plan}.
\item A function \code{calculate_mode()} used to compute the coverage mode.
}
}
\section{What this stage produces}{

\itemize{
\item Coverage metrics: \verb{coverage_level_percent_\{max,avg,dominant,wavg,aggregate\}}
\item Financial totals: \code{net_reporting_level_amount}, \code{liability_amount},
\code{total_premium_amount}, \code{subsidy_amount}
\item Ratios: \code{premium_per_liability}, \code{subsidy_per_premium}
}
}

\section{Data source}{

Downloads a released \code{.rds}:
\code{USFarmSafetyNetLab/sob/sobtpu_all.rds} (GitHub Releases).
}

\seealso{
Other FCIP Demand Estimation: 
\code{\link{estimate_fcip_instruments}()},
\code{\link{fcip_demand_data_controls}()},
\code{\link{fcip_demand_data_dispatcher}()},
\code{\link{fcip_demand_data_finalize}()},
\code{\link{fcip_demand_data_reconcile_acreage}()},
\code{\link{get_yu2018_instrument}()}
}
\concept{FCIP Demand Estimation}
