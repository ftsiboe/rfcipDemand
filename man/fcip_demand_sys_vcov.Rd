% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/fcip_demand_sys_estimate.R
\name{fcip_demand_sys_vcov}
\alias{fcip_demand_sys_vcov}
\title{Two-way cluster-robust covariance for FCIP demand models}
\usage{
fcip_demand_sys_vcov(
  object,
  data,
  kind = c("systemfit", "lm"),
  pool_col = "pool",
  year_col = "commodity_year",
  NFE = 0L,
  n_partial = 0L,
  n_eq = NULL
)
}
\arguments{
\item{object}{Fitted model: either a \code{systemfit} or \code{lm}.}

\item{data}{Estimation data containing pool and year identifiers.}

\item{kind}{One of \code{c("systemfit","lm")}. If omitted, auto-detected.}

\item{pool_col}{Name of the pool/cluster id column in \code{data} (default \code{"pool"}).}

\item{year_col}{Name of the year/time id column in \code{data} (default \code{"crop_yr"}).}

\item{NFE}{Integer; number of absorbed fixed effects (for df rescaling).}

\item{n_partial}{Integer; count of variables partialed out per equation.}

\item{n_eq}{Integer; number of equations (\code{length(object$eq)} for
\code{systemfit}, \code{1} for \code{lm}). You can override if needed.}
}
\value{
Covariance matrix aligned with \code{coef(object)}.
}
\description{
Computes a Cameron-Gelbach-Miller two-way cluster-robust covariance matrix
using inclusion-exclusion: \eqn{V = V_{pool} + V_{year} - V_{pool\_year}}.
Works for both \code{systemfit} (stacked system) and \code{lm} (first-stage).
}
\details{
\strong{Rescaling.} Let \eqn{n} be the number of observations (stacked across
equations for \code{systemfit}). With \eqn{k_old} the number of coefficients
and \eqn{k_new = k_old + NFE + n\_partial * n\_eq}, the returned matrix is
scaled by \eqn{(n - k_old - 1) / (n - k_new - 1)}.

\strong{Row alignment (lm).} Rows used by \code{lm} are inferred from
\code{rownames(model.matrix(object))}. If they cannot be mapped back to
\code{data}, the first \code{nobs(object)} rows are used.
}
